
==================
| Encloud API v1 |
==================

[ Updates ]

    1.1:
        - setup: logPort setting

[  Type definitions ]

     <bool>     Boolean - "true" | "false"
     <short>    Integer between 0 and 65535
     <uuid>     Universally Unique Identifier - e.g. "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
     <sb_url>   Switchboard URL
     <e_url>    Encloud URL


[ Switchboard Setup Notification ]

* POST <sb_url>/manage/commands/commands.access.cloud.setup                 [[TODO]]

    e.g. 1      port=1234


[ State Retrieval ]

* GET <e_url>/api/v1/status

    Def "state"        -1      None
                        0      Idle            (grey)
                        1      Error           (red)
                        2      Setting Up      (yellow)
                        3      Connecting      (orange)
                        4      Connected       (green)

    e.g.    '{
                "state" : 1,                    # string representation of state
                "error" : {                     # OPTIONAL: defined if state == 1 (StateError)
                    "code" : 123,               # error code (Please refer to <encloud/Error> for definition)
                    "seq" : 111,                # sequence number used to detect whether error instance has 
                                                # changed compared to previously retrieved value
                    "desc" : "option string description of error",
                    "extra" : "extra error message"
                },
                "progress" {                    # OPTIONAL
                    "desc: "Step description",  # string representation of step
                    "step": 2,                  # current step number 
                    "step": 5                   # total number of steps
                },
                "fallback" : true,              # OPTIONAL (default=false) true if fallback VPN server is being used
                "need" : "license sb_auth"      # OPTIONAL list of space-separated "need" strings
            }'                                  # to be fulfilled via API. Possible values:
                                                # "license" (SECE), "sb_auth", "proxy_auth"


[ Authentication/Login API ]

* POST <e_url>/api/v1/auth

    e.g. 1              id=proxy&type=http&url=<url>&user=myuser&pass=mypass
    e.g. 2              id=sb&type=user-pass&url=<url>&user=myuser&pass=mypass
    e.g. 3              id=sb&type=x509&url=<url>&pass=mypass&path=c:\key.p12

    Def "id"            OPTIONAL authentication identifier: "sb" (default), "proxy"
    Def "type"          OPTIONAL type of authentication: "user-pass" (default), "x509"
    Def "url"           destination url (for Switchboard login or proxy)
    Def "user"          user for authentication
    Def "pass"          password for authentication
    Def "path"          OPTIONAL path (for type=x509)


[ Setup API ]             

* GET <e_url>/api/v1/setup                  Client: ECE

    Def "poi"           <uuid> proof of identity returned by ECE for Switchboard association

    e.g.    '{
                 "poi" : "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
             }'

* POST <e_url>/api/v1/setup                 Client: SECE          

    Def "license"       <uuid> license entered by user to activate SECE

    e.g.                license=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee

* POST <e_url>/api/v1/setup                 Client: QCC

    Def "clientPort"    <short> Port at which client can be reached - set by GUI and used by Encloud 
                        to forward application open/close requests via Cloud API

    e.g.                clientPort=12345

    Def "logPort"       <short> Port at which LogListener can be reached - set by GUI and used by Encloud 

    e.g.                logPort=12345

* GET <e_url>/api/v1/setup                  Client: QCC

    e.g.    '{
                 "time" : 1396014836.523807,        # When the config data was received
                 "server" : {
                     "uuid" : "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
                     "openvpn_internal_ip" : "192.168.150.1",
                     "fallback_openvpn_internal_ip" : "192.168.151.1"
                     "available_pages" : { "settings" : "/manage/access/settings/standalone/",      # [...]
                 },
                 "client" : {
                    "already_connected" : false,
                 }
             }'


[ Cloud API ]

* POST <e_url>/api/v1/cloud

    Def "action"        Operation:                  Clients:

                        "start","stop"              GUI/browser
                        "syncRoutes"                Switchboard
                        "open","close"              Switchboard

    client -> encloud:

    e.g. 1              action=start
    e.g. 2              action=syncRoutes&ips=192.168.1.100,192.168.1.101

    encloud -> gui (QCC):

    e.g. 3              action=open&name=myApp&endpoint=myEndpoint&remark=myRemark&path=
                            /%HOME_PATH%/to/File&args=param1%20param2
    e.g. 4              action=close&name=myApp&endpoint=myEndpoint

    Notes: 
        * ID = name+endpoint


[ Config API ]

* GET <e_url>/api/v1/config

    e.g.    '{
                 "log" : { "lev" : 3 }
            '}


* POST <e_url>/api/v1/config

   Content-Type = application/json

    e.g. 1              { "timeout" : "300" }
    e.g. 2              { "ssl" : { "verify_ca" : "false" } }
    e.g. 3              { "log" : { "lev" : "7" } }


[ Error Handling ]

Possible HTTP Statuses return as a result of GET/POST:
     - LIBENCLOUD_HTTP_STATUS_OK
     - LIBENCLOUD_HTTP_STATUS_BADMETHOD
     - LIBENCLOUD_HTTP_STATUS_BADREQUEST
     - LIBENCLOUD_HTTP_STATUS_NOTFOUND

Application errors are available "State Retrieval API" above.


[ Other Notes ]

* Requests

All POST requests have Content-Type 'application/x-www-form-urlencoded', unless
otherwise specified.

* Responses

By default, the Content-type of responses is application/json:

e.g.    '{ ... }'

Optionally (if requests contains the "callback" parameter), responses will
contain json wrapped in a javascript function (JSONP handling to bypass
same-origin policy). In such case the returned Content-Type will be
application/javascript.

e.g.    'myJsonpCallback({ ... })'

        , where callback="myJsonpCallback"
