[[ Test environment info ]]

[ CA setup ]

$ /usr/lib/ssl/misc/CA.pl -newca

Make sure you set the CN to be equal to hostname used in requests.

[ Keypair setup ]

$ mkdir $CA_DIR && cd $CA_DIR

Generate client keypair:

$ mkdir $CLI_DIR && cd $CLI_DIR
$ openssl genrsa -out mykey.pem $CLI_KEYSZ
$ openssl req -new -key mykey.pem -out myreq.pem
$ cd -
$ openssl ca -in $CLI_DIR/myreq.perm -out $CLI_DIR/mycert.pem

Repeat same operations for webserver with $SRV_DIR and $SRV_KEYSZ.

[ Webserver setup ]

$ sudo a2enmod ssl
$ sudo ln -s /etc/apache2/sites-available/default-ssl /etc/apache2/sites-enabled/001-default-ssl

Set the following in 001-default-ssl:
    - SSLCertificateFile $SRV_DIR/mycert.pem
    - SSLCertificateKeyFile $SRV_DIR/mykey.pem
    - SSLCACertificateFile $CA_DIR/demoCA/cacert.pem
    - SSLVerifyClient require
    - SSLVerifyDepth 10

$ sudo service apache2 restart
